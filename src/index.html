<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LifeStories - Connexion Collaborative</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico" />

    <!-- CSS Biblioth√®ques externes -->
    <link
      href="libs/vis-timeline/vis-timeline-graph2d.min.css"
      rel="stylesheet"
      type="text/css"
    />
    <link rel="stylesheet" href="libs/leaflet/leaflet.css" />
    <link
      href="libs/sweetalert2/sweetalert2.min.css"
      rel="stylesheet"
      type="text/css"
    />

    <script src="libs/vis-timeline/vis-timeline-graph2d.min.js"></script>

    <!-- CSS Application LifeStories -->
    <link rel="stylesheet" href="css/app.css" />
    <link rel="stylesheet" href="css/onboarding.css" />
    <link rel="stylesheet" href="css/homepage.css" />
    <link rel="stylesheet" href="css/questionnaire.css" />
    <link rel="stylesheet" href="css/calendar.css" />
    <link href="css/bloc_border.css" rel="stylesheet" type="text/css" />
    <link href="css/splitscreen.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="css/sidebar.css" />
    <link rel="stylesheet" href="css/dashboard.css" />
  </head>

  <body>
    <div id="homepage-root"></div>
    <div id="dashboard-root" style="display:none"></div>
    <div class="onboarding-container" style="display: none">
      <header>
        <img src="./assets/imgs/logo.png" alt="Logo LifeStories" />
        <h1>LifeStories</h1>
      </header>

      <div id="status-root"></div>

      <!-- Step 1: Role Selection -->
      <div class="role-selection" id="roleSelection">
        <h2>Choisissez votre r√¥le</h2>
        <!-- <p>...et laissez le voyage commencer</p> -->
        <div class="role-cards">
          <div class="role-card">
            <button id="selectInterviewer" class="interviewer-btn">
              <img
                src="assets/imgs/enqueteur.png"
                alt="Enqu√™teur"
                class="role-icon"
              />
              <span>Enqu√™teur</span>
            </button>
          </div>

          <div class="role-card">
            <button id="selectInterviewee" class="interviewee-btn">
              <img
                src="assets/imgs/enquet√©.png"
                alt="Enqu√™t√©"
                class="role-icon"
              />
              <span>Enqu√™t√©</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Step 2A: Interviewer Flow (Host) -->
      <div class="interviewer-flow hidden" id="interviewerFlow">
        <!-- Offer display -->
        <div class="offer-display" id="offerDisplay">
          <h3 id="offerTitle">Il est temps de se connecter</h3>
          <div class="qr-section">
            <canvas id="qrCanvas"></canvas>
            <textarea
              id="connectionCode"
              readonly
              placeholder="G√©n√©ration du code..."
            ></textarea>
            <button id="copyBtn" class="copy-btn">üìã Copier le code</button>
          </div>
          <button
            id="continueOfferBtn"
            class="continue-btn"
            style="float: right; margin: 32px 0 0 0"
          >
            Continuer
          </button>
        </div>

        <!-- Waiting for response -->
        <div class="wait-response hidden" id="waitResponse">
          <h3>Vous avez bient√¥t finit</h3>
          <p>Vous devez scanner le code QR de l'enquet√©</p>
          <div class="scan-area">
            <div class="scan-frame">
              <button
                id="scanResponseBtn"
                class="scan-btn"
                title="Scanner la r√©ponse"
              ></button>
              <div class="corner top-left"></div>
              <div class="corner top-right"></div>
              <div class="corner bottom-left"></div>
              <div class="corner bottom-right"></div>
            </div>
          </div>
          <div class="manual-input">
            <textarea
              id="responseInput"
              placeholder="Ou collez la r√©ponse ici..."
            ></textarea>
            <button id="processResponseBtn" class="secondary-btn" disabled>
              Traiter la r√©ponse
            </button>
          </div>
        </div>
      </div>

      <!-- Step 2B: Interviewee Flow (Guest) -->
      <div class="interviewee-flow hidden" id="intervieweeFlow">
        <!-- Scan/paste offer -->
        <div class="scan-offer" id="scanOffer">
          <h3>Il est temps de se connecter</h3>
          <p>Scannez le QR code fourni par l'enqu√™teur</p>
          <div class="scan-area">
            <div class="scan-frame">
              <button
                id="scanBtn"
                class="scan-btn"
                title="Scanner le QR Code"
              ></button>
              <div class="corner top-left"></div>
              <div class="corner top-right"></div>
              <div class="corner bottom-left"></div>
              <div class="corner bottom-right"></div>
            </div>
          </div>
          <div class="manual-input">
            <textarea
              id="connectionInput"
              placeholder="Ou collez le code de connexion ici..."
            ></textarea>
            <button id="btn1" class="secondary-btn" disabled>
              Recevoir le code
            </button>
          </div>
        </div>

        <!-- Answer display -->
        <div class="answer-display hidden" id="answerDisplay">
          <h3>Vous avez bient√¥t finit</h3>
          <p>Partagez ce code avec l'enqu√™teur</p>
          <div class="qr-section">
            <canvas id="qrCanvasAnswer"></canvas>
            <textarea
              id="answerCode"
              readonly
              placeholder="G√©n√©ration de la r√©ponse..."
            ></textarea>
            <button id="copyAnswerBtn" class="copy-btn">
              üìã Copier la r√©ponse
            </button>
          </div>
        </div>
      </div>

      <div class="status-section">
        <div id="statusMessage" class="status-message"></div>
        <div class="progress-bar hidden" id="progressBar">
          <div class="progress-fill"></div>
        </div>
      </div>

      <div class="actions hidden" id="connectedActions">
        <h3>Connexion √©tablie !</h3>
        <p>Lancement de LifeStories...</p>
        <div class="auto-start-indicator">
          <div class="spinner"></div>
        </div>
      </div>

      <button id="confirm-button" class="hidden">Confirmer</button>
    </div>
    <!-- Fin de .onboarding-container -->

    <!-- Section LifeStories (cach√©e au d√©marrage) -->
    <div class="lifestories-container" id="lifestoriesContainer">
      <!-- Indicateur de statut WebRTC -->
      <div id="webrtc-status-root"></div>

      <!-- Bouton de reconnexion (cach√© par d√©faut) -->
      <div id="reconnect-container" class="hidden">
        <div>
          <h1>Connexion perdue</h1>
          <img src="assets/imgs/connectionlost.png" alt="Connexion perdue" />
          <span>Connexion perdue : veuillez vous reconnecter</span>
          <button id="reconnect-btn" class="reconnect-button">
            Se reconnecter
          </button>
        </div>
      </div>

      <!-- Bouton mode d√©veloppeur sur la vue standard -->
      <button
        id="devmode-toggle-standard"
        style="position: fixed; top: 16px; right: 16px; z-index: 1000; background: #fff; border: 1px solid #ccc; border-radius: 4px; padding: 4px 10px; font-size: 14px; cursor: pointer; display: none; align-items: center;"
        title="Basculer le mode d√©veloppeur"
      >
        <span style="margin-right: 6px;">üõ†Ô∏è</span>
        Mode standard
      </button>

      <div class="split">
        <!-- Left side-->
          <div id="questionnaire">
          <div class="questionnaire-header">
            <h2 style="margin: 0;"><i data-lucide="house"></i> Migratoire</h2>
          </div>
          <div id="questions"></div>
          <!-- Footer actions: kept at the end of the questionnaire -->
          <div class="questionnaire-footer" style="margin-top:12px; display:flex; gap:8px; align-items:center; justify-content:flex-end;">
            <div id="questionnaire-actions">
              <button id="export">Export</button>
              <button id="load">Load</button>
            </div>
            <button id="resetButton" title="R√©initialiser le questionnaire">üóëÔ∏è</button>
          </div>
        </div>

        <!-- Right side-->
        <div id="trajectories" class="split vertical">
          <div id="canvas">
            <div id="birth-year"></div>
            <div id="timeline"></div>
          </div>
          <section id="bricks">
            <div class="title-row">
              <header>
                <h2>Synth√®se</h2>
                <p id="year"></p>
              </header>
              <button id="close-summary" class="invisible-button"><i data-lucide="x"></i></button>
            </div>
            <div id="moreInfos" class="stat-wrapper">
            </div>
            <div class="btn-wrapper">
              <div class="btn-group">
                <button id="move-backwards"><i data-lucide="chevron-left"></i></button>
                <button id="move-forwards"><i data-lucide="chevron-right"></i></button>
              </div>
              <div class="btn-group">
                <button id="zoom-out" ><i data-lucide="zoom-out"></i></button>
                <button id="zoom-in" ><i data-lucide="zoom-in"></i></button>
              </div>
            </div>
          </section>
          <section class="calendar-info-bar">
            <h2><i data-lucide="house"></i> 1. Migratoire</h2>
            <div class="btn-wrapper">
              <div class="btn-group">
                <button id="move-backwards"><i data-lucide="chevron-left"></i></button>
                <button id="move-forwards"><i data-lucide="chevron-right"></i></button>
              </div>
              <div class="btn-group">
                <button id="zoom-out" ><i data-lucide="zoom-out"></i></button>
                <button id="zoom-in" ><i data-lucide="zoom-in"></i></button>
              </div>
              <button id="view-summary" class="secondary-button button-with-icon"><i data-lucide="square-chart-gantt"></i> view summary</button>
            </div>
          </section>
          <div id="map"></div>
        </div>
      </div>
    </div>

    <!-- Scripts Onboarding -->
    <script type="module" src="/main.jsx"></script>
    <script src="js/qrcode.min.js"></script>
    <script src="js/qr-gen.js"></script>
    <script src="js/qr-scan.js"></script>
    <script src="js/webrtc-onboarding.js"></script>

    <!-- Scripts LifeStories (libs externes) -->
    <script src="libs/sweetalert2/sweetalert2.min.js"></script>
    <script src="libs/leaflet/leaflet.js"></script>
    <script src="libs/split.js/split.min.js"></script>
    <script src="libs/lucide/lucide.js"></script>

    <!-- XState UMD - doit √™tre charg√© avant les modules -->
    <script src="libs/xstate/xstate.js"></script>
    <!-- Scripts LifeStories (modules) -->
    <script type="module" src="js/timeline.js"></script>
    <script type="module" src="js/questionnaire/questionnaire.js"></script>
    <script type="module" src="js/utils.js"></script>
    <script type="module" src="js/stateMachine.js"></script>
    <script type="module" src="js/webrtc-sync.js"></script>

    <script>
      // Afficher le bouton mode d√©veloppeur sur la vue standard si devMode est actif
      document.addEventListener('DOMContentLoaded', function() {
        if (localStorage.getItem('devMode') === 'true') {
          const btn = document.getElementById('devmode-toggle-standard');
          if (btn) btn.style.display = 'flex';
          if (btn) {
            btn.onclick = function() {
              localStorage.setItem('devMode', 'false');
              window.location.reload();
            };
          }
        }
      });
      // Initialiser Split.js quand LifeStories est affich√©
      document.addEventListener("lifestoriesShown", () => {
        // Petit d√©lai pour que le DOM soit compl√®tement rendu
        setTimeout(() => {
          // V√©rifier si on est en mode viewer
          const isViewer =
            sessionStorage.getItem("webrtc_isOfferor") === "false";
          const isInterviewer = sessionStorage.getItem("webrtc_isOfferor") === "true";

          // Vue enqu√™teur : masquer le calendrier et la synth√®se, afficher uniquement le questionnaire
          if (isInterviewer) {
            // Ajouter une classe au body pour permettre le CSS de la sidebar
            document.body.classList.add('interviewer-mode');
            
            const trajectoriesSection = document.getElementById("trajectories");
            const questionnaireSection = document.getElementById("questionnaire");
            if (trajectoriesSection) {
              trajectoriesSection.style.display = "none";
            }
            if (questionnaireSection) {
              questionnaireSection.style.width = "100%";
              questionnaireSection.style.maxWidth = "100%";
            }
          }

          // Vue enqu√™t√© : masquer le questionnaire, afficher uniquement le calendrier
          if (isViewer) {
            const questionnaireSection = document.getElementById("questionnaire");
            const trajectoriesSection = document.getElementById("trajectories");
            if (questionnaireSection) {
              questionnaireSection.style.display = "none";
            }
            if (trajectoriesSection) {
              trajectoriesSection.style.width = "100%";
              trajectoriesSection.style.maxWidth = "100%";
            }
          }

          // Initialiser Split.js seulement si les deux sections sont visibles (ni enqu√™teur ni enqu√™t√©)
          if (!isViewer && !isInterviewer) {
            Split(["#questionnaire", "#trajectories"], {
              sizes: [20, 80],
              minSize: 100,
              gutterSize: 8,
              cursor: "col-resize",
            });
          }

          // Forcer un redraw de la timeline apr√®s l'affichage (si elle existe)
          if (window.timeline && typeof window.timeline.redraw === "function") {
            window.timeline.redraw();
          }
        }, 100);
      });

      lucide.createIcons();
    </script>
  </body>
</html>
