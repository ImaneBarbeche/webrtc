<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1, viewport-fit=cover"
    />
    <title>LifeStories - Connexion Collaborative</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico" />

    <!-- CSS BibliothÃ¨ques externes -->
    <link
      href="libs/vis-timeline/vis-timeline-graph2d.min.css"
      rel="stylesheet"
      type="text/css"
    />
    <link rel="stylesheet" href="libs/leaflet/leaflet.css" />
    <link
      href="libs/sweetalert2/sweetalert2.min.css"
      rel="stylesheet"
      type="text/css"
    />

    <script src="libs/vis-timeline/vis-timeline-graph2d.min.js"></script>

    <!-- CSS Application LifeStories -->
    <link rel="stylesheet" href="css/app.css" />
    <link rel="stylesheet" href="css/onboarding.css" />
    <link rel="stylesheet" href="css/homepage.css" />
    <link rel="stylesheet" href="css/questionnaire.css" />
    <link rel="stylesheet" href="css/calendar.css" />
    <link href="css/bloc_border.css" rel="stylesheet" type="text/css" />
    <link href="css/splitscreen.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="css/sidebar.css" />
    <link rel="stylesheet" href="css/dashboard.css" />
    <link rel="stylesheet" href="css/dropdown-status.css" />
  </head>

  <body>
    <!-- Global dev-mode toggle (always present) -->
    <button id="devmode-toggle-global" title="Basculer le mode dÃ©veloppeur" style="position:fixed; top:8px; right:8px; z-index:2000; width:44px; height:44px; border-radius:8px; background:var(--primary-dark,#2b6cb0); color:#fff; border:none; display:flex; align-items:center; justify-content:center;">
      <i data-lucide="bug"></i>
    </button>
    <div id="homepage-root"></div>
    <div id="dashboard-root" style="display: none"></div>
    <div class="onboarding-container" style="display: none">
      <header>
        <img src="./assets/imgs/logo.png" alt="Logo LifeStories" />
        <h1>LifeStories</h1>
      </header>

      <div id="status-root"></div>

      <!-- Step 1: Role Selection -->
      <div class="role-selection" id="roleSelection">
        <h2>Choisissez votre rÃ´le</h2>
        <!-- <p>...et laissez le voyage commencer</p> -->
        <div class="role-cards">
          <div class="role-card">
            <button id="selectInterviewer" class="interviewer-btn">
              <img
                src="assets/imgs/enqueteur.png"
                alt="EnquÃªteur"
                class="role-icon"
              />
              <span>EnquÃªteur</span>
            </button>
          </div>

          <div class="role-card">
            <button id="selectInterviewee" class="interviewee-btn">
              <img
                src="assets/imgs/enquetÃ©.png"
                alt="EnquÃªtÃ©"
                class="role-icon"
              />
              <span>EnquÃªtÃ©</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Step 2A: Interviewer Flow (Host) -->
      <div class="interviewer-flow hidden" id="interviewerFlow">
        <!-- Offer display -->
        <div class="offer-display" id="offerDisplay">
          <h3 id="offerTitle">Il est temps de se connecter</h3>
          <div class="qr-section">
            <canvas id="qrCanvas"></canvas>
            <textarea
              id="connectionCode"
              readonly
              placeholder="GÃ©nÃ©ration du code..."
            ></textarea>
            <button id="copyBtn" class="copy-btn">ðŸ“‹ Copier le code</button>
          </div>
          <button
            id="continueOfferBtn"
            class="continue-btn"
            style="float: right; margin: 32px 0 0 0"
          >
            Continuer
          </button>
        </div>

        <!-- Waiting for response -->
        <div class="wait-response hidden" id="waitResponse">
          <h3>Vous avez bientÃ´t finit</h3>
          <p>Vous devez scanner le code QR de l'enquetÃ©</p>
          <div class="scan-area">
            <div class="scan-frame">
              <button
                id="scanResponseBtn"
                class="scan-btn"
                title="Scanner la rÃ©ponse"
              ></button>
              <div class="corner top-left"></div>
              <div class="corner top-right"></div>
              <div class="corner bottom-left"></div>
              <div class="corner bottom-right"></div>
            </div>
          </div>
          <div class="manual-input">
            <textarea
              id="responseInput"
              placeholder="Ou collez la rÃ©ponse ici..."
            ></textarea>
            <button id="processResponseBtn" class="secondary-btn" disabled>
              Traiter la rÃ©ponse
            </button>
          </div>
        </div>
      </div>

      <!-- Step 2B: Interviewee Flow (Guest) -->
      <div class="interviewee-flow hidden" id="intervieweeFlow">
        <!-- Scan/paste offer -->
        <div class="scan-offer" id="scanOffer">
          <h3>Il est temps de se connecter</h3>
          <p>Scannez le QR code fourni par l'enquÃªteur</p>
          <div class="scan-area">
            <div class="scan-frame">
              <button
                id="scanBtn"
                class="scan-btn"
                title="Scanner le QR Code"
              ></button>
              <div class="corner top-left"></div>
              <div class="corner top-right"></div>
              <div class="corner bottom-left"></div>
              <div class="corner bottom-right"></div>
            </div>
          </div>
          <div class="manual-input">
            <textarea
              id="connectionInput"
              placeholder="Ou collez le code de connexion ici..."
            ></textarea>
            <button id="btn1" class="secondary-btn" disabled>
              Recevoir le code
            </button>
          </div>
        </div>

        <!-- Answer display -->
        <div class="answer-display hidden" id="answerDisplay">
          <h3>Vous avez bientÃ´t finit</h3>
          <p>Partagez ce code avec l'enquÃªteur</p>
          <div class="qr-section">
            <canvas id="qrCanvasAnswer"></canvas>
            <textarea
              id="answerCode"
              readonly
              placeholder="GÃ©nÃ©ration de la rÃ©ponse..."
            ></textarea>
            <button id="copyAnswerBtn" class="copy-btn">
              ðŸ“‹ Copier la rÃ©ponse
            </button>
          </div>
        </div>
      </div>

      <div class="status-section">
        <div id="statusMessage" class="status-message"></div>
        <div class="progress-bar hidden" id="progressBar">
          <div class="progress-fill"></div>
        </div>
      </div>

      <div class="actions hidden" id="connectedActions">
        <h3>Connexion Ã©tablie !</h3>
        <p>Lancement de LifeStories...</p>
        <div class="auto-start-indicator">
          <div class="spinner"></div>
        </div>
      </div>

      <button id="confirm-button" class="hidden">Confirmer</button>
    </div>
    <!-- Fin de .onboarding-container -->

    <!-- Section LifeStories (cachÃ©e au dÃ©marrage) -->
    <div class="lifestories-container" id="lifestoriesContainer">
      <!-- Indicateur de statut WebRTC -->
      <div id="webrtc-status-root"></div>

      <!-- Bouton de reconnexion (cachÃ© par dÃ©faut) -->
      <div id="reconnect-container" class="hidden">
        <div>
          <h1>Connexion perdue</h1>
          <img src="assets/imgs/connectionlost.png" alt="Connexion perdue" />
          <span>Connexion perdue : veuillez vous reconnecter</span>
          <button id="reconnect-btn" class="reconnect-button">
            Se reconnecter
          </button>
        </div>
      </div>

      <!-- Dev-mode toggle handled by React (HomePage.jsx) -->

      <div class="split">
        <!-- Left side-->
        <div id="questionnaire">
          <div class="questionnaire-header">
            <h2 style="margin: 0"><i data-lucide="house"></i> Migratoire</h2>
          </div>
          <div id="questions"></div>
          <!-- Footer actions: kept at the end of the questionnaire -->
          <div
            class="questionnaire-footer"
            style="
              margin-top: 12px;
              display: flex;
              gap: 8px;
              align-items: center;
              justify-content: flex-end;
            "
          >
            <div id="questionnaire-actions">
              <button id="export" title="Exporter">
                <i data-lucide="upload"></i>
              </button>
              <button id="load" title="Charger">
                <i data-lucide="download"></i>
              </button>
            </div>
            <button id="resetButton" title="RÃ©initialiser le questionnaire">
              <i data-lucide="trash"></i>
            </button>
          </div>
        </div>

        <!-- Right side-->
        <div id="trajectories" class="split vertical">
          <div id="canvas">
            <button id="birth-year" class="birth-year-btn"></button>
            <div id="timeline"></div>
          </div>
          <section id="bricks">
            <div class="title-row">
              <header>
                <h2>SynthÃ¨se</h2>
                <p id="year"></p>
              </header>
              <button id="close-summary" class="invisible-button">
                <i data-lucide="x"></i>
              </button>
            </div>
            <div id="moreInfos" class="stat-wrapper"></div>
            <div class="btn-wrapper">
              <div class="btn-group">
                <button id="move-backwards">
                  <i data-lucide="chevron-left"></i>
                </button>
                <button id="move-forwards">
                  <i data-lucide="chevron-right"></i>
                </button>
              </div>
              <div class="btn-group">
                <button id="zoom-out"><i data-lucide="zoom-out"></i></button>
                <button id="zoom-in"><i data-lucide="zoom-in"></i></button>
              </div>
            </div>
          </section>
          <section class="calendar-info-bar">
            <h2><i data-lucide="house"></i> 1. Migratoire</h2>
            <div class="btn-wrapper">
              <div class="btn-group">
                <button id="move-backwards">
                  <i data-lucide="chevron-left"></i>
                </button>
                <button id="move-forwards">
                  <i data-lucide="chevron-right"></i>
                </button>
              </div>
              <div class="btn-group">
                <button id="zoom-out"><i data-lucide="zoom-out"></i></button>
                <button id="zoom-in"><i data-lucide="zoom-in"></i></button>
              </div>
              <button
                id="toggle-chapters"
                class="secondary-button button-with-icon"
              >
                <i data-lucide="swatch-book"></i>
              </button>
              <button
                id="view-summary"
                class="secondary-button button-with-icon"
              >
                <i data-lucide="square-chart-gantt"></i> view summary
              </button>
            </div>
          </section>
          <div id="map"></div>
        </div>
      </div>
    </div>

    <!-- filter test -->
    <svg xmlns="http://www.w3.org/2000/svg" style="display: none">
      <filter
        id="lensFilter"
        x="0%"
        y="0%"
        width="100%"
        height="100%"
        filterUnits="objectBoundingBox"
      >
        <feComponentTransfer in="SourceAlpha" result="alpha">
          <feFuncA type="identity" />
        </feComponentTransfer>

        <feGaussianBlur in="alpha" stdDeviation="50" result="blur" />

        <feDisplacementMap
          in="SourceGraphic"
          in2="blur"
          scale="50"
          xChannelSelector="A"
          yChannelSelector="A"
        />
      </filter>
    </svg>

    <!-- Scripts Onboarding -->
    <script type="module" src="/main.jsx"></script>
    <script src="js/qrcode/qrcode.min.js"></script>
    <script src="js/qrcode/qr-gen.js"></script>
    <script src="js/qrcode/qr-scan.js"></script>
    <script src="js/webrtc/webrtc-onboarding.js"></script>

    <!-- Scripts LifeStories (libs externes) -->
    <script src="libs/sweetalert2/sweetalert2.min.js"></script>
    <script src="libs/leaflet/leaflet.js"></script>
    <script src="libs/split.js/split.min.js"></script>
    <script src="libs/lucide/lucide.js"></script>
  
    <!-- XState UMD - doit Ãªtre chargÃ© avant les modules -->
    <script src="libs/xstate/xstate.js"></script>
    <!-- Scripts LifeStories (modules) -->
    <script type="module" src="js/timeline/timeline.js"></script>
    <script type="module" src="js/questionnaire/questionnaire.js"></script>
    <script type="module" src="js/utils.js"></script>
    <script type="module" src="js/stateMachine/stateMachine.js"></script>
    <script type="module" src="js/webrtc/webrtc-sync.js"></script>

    <script>
      // Global dev-mode toggle (fallback) - ensure it's clickable in any view
      (function(){
        const btn = document.getElementById('devmode-toggle-global');
        if (!btn) return;
        btn.addEventListener('click', function(){
          const isDev = localStorage.getItem('devMode') === 'true';
          localStorage.setItem('devMode', isDev ? 'false' : 'true');
          window.location.reload();
        });
      })();
      // Hide the global toggle if React renders its own `.devmode-toggle` button
      (function(){
        const globalBtn = document.getElementById('devmode-toggle-global');
        if (!globalBtn) return;

        function hideIfReactPresent() {
          const reactBtn = document.querySelector('.devmode-toggle');
          if (reactBtn) {
            globalBtn.style.display = 'none';
          } else {
            globalBtn.style.display = '';
          }
        }

        // Initial check
        hideIfReactPresent();

        // Observe DOM for added nodes (React mount may happen after load)
        const obs = new MutationObserver(hideIfReactPresent);
        obs.observe(document.body, { childList: true, subtree: true });
        // Stop observing after some time to avoid long-lived observers
        setTimeout(() => obs.disconnect(), 15000);
      })();

      // Initialiser Split.js quand LifeStories est affichÃ©
      document.addEventListener("lifestoriesShown", () => {
        // Petit dÃ©lai pour que le DOM soit complÃ¨tement rendu
        setTimeout(() => {
          // VÃ©rifier si on est en mode viewer
          const isViewer =
            sessionStorage.getItem("webrtc_isOfferor") === "false";
          const isInterviewer =
            sessionStorage.getItem("webrtc_isOfferor") === "true";

          // Vue enquÃªteur : masquer le calendrier et la synthÃ¨se, afficher uniquement le questionnaire
          if (isInterviewer) {
            // Ajouter une classe au body pour permettre le CSS de la sidebar
            document.body.classList.add("interviewer-mode");

            const trajectoriesSection = document.getElementById("trajectories");
            const questionnaireSection =
              document.getElementById("questionnaire");
            if (trajectoriesSection) {
              trajectoriesSection.style.display = "none";
            }
            if (questionnaireSection) {
              questionnaireSection.style.width = "100%";
              questionnaireSection.style.maxWidth = "100%";
            }
          }

          // Vue enquÃªtÃ© : masquer le questionnaire, afficher uniquement le calendrier
          if (isViewer) {
            const questionnaireSection =
              document.getElementById("questionnaire");
            const trajectoriesSection = document.getElementById("trajectories");
            if (questionnaireSection) {
              questionnaireSection.style.display = "none";
            }
            if (trajectoriesSection) {
              trajectoriesSection.style.width = "100%";
              trajectoriesSection.style.maxWidth = "100%";
            }
          }

          // Initialiser Split.js seulement si les deux sections sont visibles (ni enquÃªteur ni enquÃªtÃ©)
          if (!isViewer && !isInterviewer) {
            Split(["#questionnaire", "#trajectories"], {
              sizes: [20, 80],
              minSize: 100,
              gutterSize: 8,
              cursor: "col-resize",
            });
          }

          // Forcer un redraw de la timeline aprÃ¨s l'affichage (si elle existe)
          if (window.timeline && typeof window.timeline.redraw === "function") {
            window.timeline.redraw();
          }
        }, 100);
      });

      lucide.createIcons();
    </script>
  </body>
</html>
